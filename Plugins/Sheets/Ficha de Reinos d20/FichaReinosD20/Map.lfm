<?xml version="1.0" encoding="UTF-8"?>
<form name="frmMap" align="client">
	<scrollBox align="client" name="mapa">
		<rectangle left="0" top="0" width="1152" height="648" color="black" name="mapRectangle"/>
		<image width="1152" height="648" field="mapa" name="mapImage" hitTest="true" style="proportional" hint="Clique para alterar Imagem, shift+clique para adicionar Cidade, ctrl+clique para adicionar Ponto de Interesse. ">
			<event name="onMouseDown">
				sheet.button = event.button;
				sheet.x = event.x;
				sheet.y = event.y;
				sheet.shiftKey = event.shiftKey;
				sheet.ctrlKey = event.ctrlKey;
				sheet.altKey = event.altKey;
			</event>
			<event name="onClick">
				<![CDATA[
				if sheet==nil then return end;
				
				local mesa = rrpg.getMesaDe(sheet);
				local mapImage = self:findControlByName("mapImage");



				if sheet.shiftKey then
					if not ndb.testPermission(sheet, "write") then return end;
					-- Adicionar Cidade
					if sheet.cityNum == nil then
						sheet.cityNum = 0;
					end;
					sheet.cityNum = sheet.cityNum + 1;

					local scale = 1;
					if mapImage.scale > 1 then
						scale = 0.5;
					end;

					local btn = gui.newButton();
					btn.parent = self.mapa;
					btn.left = (sheet.x-12)/scale;
					btn.top = (sheet.y-12)/scale;
					btn.width = 25/scale;
					btn.height = 25/scale;
					btn.cursor = "handPoint";
					btn.hint = "Cidade";
					btn.opacity = 0.35;
					btn.name = "button_c"..sheet.cityNum;
					btn.text = "";

					local node = self.rclDestalhesDaCidade:append();
					node.name = btn.name;
					node.left = btn.left * scale;
					node.top = btn.top * scale;
					node.nome = "Cidade";

					local cidades = ndb.getChildNodes(sheet.listaDeDestalhesDaCidade);
					node.contador = #cidades;

					btn.onClick = function() 
						self.boxDetalhesDaCidade.node = node; 
						self.boxDetalhesDaCidade.visible = (node ~= nil);
						self.tabControl.tabIndex = 2;
					end;

					self.boxDetalhesDaCidade.node = node;
					self.boxDetalhesDaCidade.visible = (node ~= nil);
					self.tabControl.tabIndex = 2;

				elseif sheet.ctrlKey then
					if not ndb.testPermission(sheet, "write") then return end;
					-- Adicionar Ponto de Interesse
					if sheet.geographyNum == nil then
						sheet.geographyNum = 0;
					end;
					sheet.geographyNum = sheet.geographyNum + 1;

					local scale = 1;
					if mapImage.scale > 1 then
						scale = 0.5;
					end;

					local btn = gui.newButton();
					btn.parent = self.mapa;
					btn.left = (sheet.x-15)/scale;
					btn.top = (sheet.y-15)/scale;
					btn.width = 30/scale;
					btn.height = 30/scale;
					btn.cursor = "handPoint";
					btn.hint = "Lugar";
					btn.opacity = 0.35;
					btn.name = "button_g"..sheet.geographyNum;
					btn.text = "";

					local node = self.rclDestalhesDaGeografia:append();
					node.name = btn.name;
					node.left = btn.left * scale;
					node.top = btn.top * scale;
					node.nome = "Lugar";
					
					local lugares = ndb.getChildNodes(sheet.listaDeDestalhesDaGeografia);
					node.contador = #lugares;

					btn.onClick = function() 
						self.boxDetalhesDaGeografia.node = node; 
						self.boxDetalhesDaGeografia.visible = (node ~= nil);
						self.tabControl.tabIndex = 3;
					end;

					self.boxDetalhesDaGeografia.node = node;
					self.boxDetalhesDaGeografia.visible = (node ~= nil);
					self.tabControl.tabIndex = 3;

				elseif sheet.altKey then
					-- Zoom control
					local mapRectangle = self:findControlByName("mapRectangle");
					local scale = 2;

					if mapImage.scale > 1 then
						scale = 0.5;
					end;

					mapImage.scale = mapImage.scale * scale;
					mapRectangle.width = mapRectangle.width * scale;
					mapRectangle.height = mapRectangle.height * scale;

					-- repositioning city buttons
					local cidades = ndb.getChildNodes(sheet.listaDeDestalhesDaCidade);
					for i=1, #cidades, 1 do
						local node = cidades[i];
						if node.name ~= nil then
							local btn = self:findControlByName(node.name);
							if btn ~= nil then
								btn.width = btn.width * scale;
								btn.height = btn.height * scale;
								btn.left = btn.left * scale;
								btn.top = btn.top * scale;
							end;
						end;
					end;

					-- repositioning places buttons
					local lugares = ndb.getChildNodes(sheet.listaDeDestalhesDaGeografia);
					for i=1, #lugares, 1 do
						local node = lugares[i];
						if node.name ~= nil then
							local btn = self:findControlByName(node.name);
							if btn ~= nil then
								btn.width = btn.width * scale;
								btn.height = btn.height * scale;
								btn.left = btn.left * scale;
								btn.top = btn.top * scale;
							end;
						end;
					end;

				else
					if not ndb.testPermission(sheet, "write") then return end;
					-- Alterar Imagem
					Dialogs.selectImageURL(nil,
						function(url)
							sheet.mapa = url;
						end);
				end;
				]]>
			</event>
		</image>
		<script>
			_obj_setProp(self.mapImage.handle, "Stretch", true);
		</script>
	</scrollBox>
</form>